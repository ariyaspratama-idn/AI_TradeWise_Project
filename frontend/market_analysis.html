<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Pasar - AI TradeWise</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        .analysis-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
        }

        .analysis-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>

<body>
    <header class="navbar">
        <div class="logo">AI TradeWise</div>
        <nav>
            <ul>
                <li><a href="index.html">Beranda</a></li>
                <li><a href="index.html#fitur">Fitur</a></li>
                <li><a href="market_analysis.html" class="active">Analisis Pasar</a></li>
                <li><a href="chat.html">Konsultasi AI</a></li>
                <li>
                    <button id="theme-toggle"
                        style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-primary);">
                        <i class="fa-solid fa-moon"></i>
                    </button>
                </li>
            </ul>
        </nav>
    </header>

    <div class="analysis-container">
        <h1>Analisis Pasar Real-Time</h1>
        <p>Data pasar terkini yang dianalisis oleh AI kami.</p>

        <div id="market-report" class="analysis-card">
            <p class="loading">Memuat data pasar...</p>
        </div>

        <div id="alerts" class="analysis-card" style="margin-top: 2rem;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h2 style="color: var(--accent-color);">Peringatan Kustom</h2>
                <p>Buat notifikasi otomatis berdasarkan kondisi pasar</p>
            </div>

            <form id="alert-form"
                style="display: flex; flex-direction: column; gap: 1rem; max-width: 600px; margin: 0 auto;">
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <label for="asset-select">Cari Aset</label>

                    <select id="asset-select">
                        <option value="">-- Pilih dari Daftar Populer --</option>
                        <optgroup label="Crypto">
                            <option value="BTC/USD">Bitcoin (BTC)</option>
                            <option value="ETH/USD">Ethereum (ETH)</option>
                            <option value="SOL/USD">Solana (SOL)</option>
                            <option value="BNB/USD">Binance Coin (BNB)</option>
                            <option value="XRP/USD">XRP</option>
                        </optgroup>
                        <optgroup label="Forex">
                            <option value="EUR/USD">EUR/USD</option>
                            <option value="GBP/USD">GBP/USD</option>
                            <option value="USD/JPY">USD/JPY</option>
                            <option value="AUD/USD">AUD/USD</option>
                        </optgroup>
                        <optgroup label="US Stocks">
                            <option value="AAPL">Apple (AAPL)</option>
                            <option value="MSFT">Microsoft (MSFT)</option>
                            <option value="GOOGL">Google (GOOGL)</option>
                            <option value="TSLA">Tesla (TSLA)</option>
                            <option value="NVDA">Nvidia (NVDA)</option>
                            <option value="AMZN">Amazon (AMZN)</option>
                        </optgroup>
                        <optgroup label="Commodities">
                            <option value="XAU/USD">Gold (XAU)</option>
                            <option value="XAG/USD">Silver (XAG)</option>
                            <option value="WTI">Crude Oil (WTI)</option>
                        </optgroup>
                    </select>


                    <div style="text-align: center; color: var(--text-secondary); font-size: 0.8rem; margin: 5px 0;">-
                        ATAU -</div>

                    <input type="text" id="asset-manual" placeholder="Ketik manual jika aset tidak ada di daftar...">
                </div>

                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label for="condition">Kondisi</label>
                        <select id="condition">
                            <option value="price_above">Harga Di Atas (>)</option>
                            <option value="price_below">Harga Di Bawah (<)< /option>
                            <option value="vol_spike">Lonjakan Volume (>200%)</option>
                            <option value="ma_cross_golden">Golden Cross (MA50 > MA200)</option>
                            <option value="ma_cross_death">Death Cross (MA50 < MA200)</option>
                            <option value="rsi_overbought">RSI Overbought (>70)</option>
                            <option value="rsi_oversold">RSI Oversold (<30)< /option>
                            <option value="sentiment_bullish">Sentimen Bullish (AI)</option>
                            <option value="sentiment_bearish">Sentimen Bearish (AI)</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label for="value">Nilai Target</label>
                        <input type="number" id="value" placeholder="Contoh: 50000">
                    </div>
                </div>

                <div>
                    <label for="channel">Metode Notifikasi</label>
                    <select id="channel">
                        <option value="email">Email</option>
                        <option value="telegram">Telegram</option>
                        <option value="whatsapp">WhatsApp</option>
                    </select>
                </div>

                <div id="contact-field" style="margin-bottom: 1rem;">
                    <label for="contact-input">Kontak Tujuan</label>
                    <input type="email" id="contact-input" placeholder="Masukkan alamat email Anda" required>
                    <p style="font-size:0.8rem; color:var(--text-secondary); margin-top:4px;">
                        <i class="fa-solid fa-shield-halved"></i> Data kontak hanya digunakan untuk notifikasi ini.
                    </p>
                </div>



                <button type="submit" class="btn-primary"
                    style="margin-top: 1rem; border: none; cursor: pointer; text-align: center; width: 100%;">
                    <i class="fa-solid fa-plus-circle" style="margin-right: 8px;"></i> Buat Peringatan
                </button>
            </form>

            <div id="active-alerts" style="margin-top: 2rem;">
                <!-- Alerts list will appear here -->
            </div>
        </div>
    </div>

    <!-- Custom Modal Structure -->
    <div id="custom-modal-overlay" class="custom-modal-overlay">
        <div class="custom-modal">
            <div style="font-size: 3rem; margin-bottom: 1rem;" id="modal-icon">✅</div>
            <h3 id="modal-title">Sukses!</h3>
            <p id="modal-message">Peringatan berhasil dibuat.</p>
            <button class="custom-modal-btn" onclick="closeCustomModal()">Siap, Mengerti!</button>
        </div>
    </div>

    <script>
        // === Custom Modal Logic ===
        function showCustomModal(title, message, isSuccess = true, waActionLink = null) {
            const overlay = document.getElementById('custom-modal-overlay');
            const titleEl = document.getElementById('modal-title');
            const msgEl = document.getElementById('modal-message');
            const iconEl = document.getElementById('modal-icon');

            // Clean up old buttons if any
            const oldBtn = document.getElementById('wa-cal-action-btn');
            if (oldBtn) oldBtn.remove();

            titleEl.innerText = title;
            msgEl.innerText = message;

            if (isSuccess) {
                iconEl.innerText = '✅';
                titleEl.style.color = '#28a745';
            } else {
                iconEl.innerText = '⚠️';
                titleEl.style.color = '#dc3545';
            }

            // Add WA Action Button if link provided
            if (waActionLink) {
                const btn = document.createElement('a');
                btn.id = 'wa-cal-action-btn';
                btn.href = waActionLink;
                btn.target = "_blank";
                btn.className = "custom-modal-btn";
                btn.style.backgroundColor = "#25D366"; // WA Green
                btn.style.marginTop = "10px";
                btn.style.display = "block";
                btn.style.textDecoration = "none";
                btn.innerHTML = '<i class="fa-brands fa-whatsapp"></i> Verifikasi Nomor (Wajib)';

                document.querySelector('.custom-modal').appendChild(btn);
            }

            overlay.classList.add('active');
        }

        function closeCustomModal() {
            document.getElementById('custom-modal-overlay').classList.remove('active');
            // Clean up
            const oldBtn = document.getElementById('wa-cal-action-btn');
            if (oldBtn) oldBtn.remove();
        }

        // === 1. Load Market Data Real-Time ===
        async function loadMarketData() {
            const reportContainer = document.getElementById('market-report');
            try {
                const res = await fetch('/market-analysis');
                if (!res.ok) throw new Error("Gagal mengambil data dari server");

                const data = await res.json();

                // Format the JSON data into HTML
                let html = `<h3>Laporan Pasar (${data.timestamp || new Date().toLocaleDateString()})</h3>`;

                if (data.overall_sentiment) {
                    html += `<p><strong>Sentimen Global:</strong> ${data.overall_sentiment}</p>`;
                }

                if (Array.isArray(data.details)) {
                    html += `<div class="grid-view" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; margin-top: 1rem;">`;

                    data.details.forEach(item => {
                        let color = '#ccc';
                        if (item.signal === 'BUY') color = '#28a745'; // Green
                        if (item.signal === 'SELL') color = '#dc3545'; // Red
                        if (item.signal === 'HOLD') color = '#ffc107'; // Yellow/Orange

                        html += `
                            <div class="card" style="border: 1px solid var(--border-color); padding: 1.2rem; border-radius: 12px; background: var(--bg-card); box-shadow: 0 2px 4px var(--shadow-color);">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 0.5rem;">
                                    <h4 style="margin:0; font-size: 1.2rem; color: var(--text-primary);">${item.symbol}</h4>
                                    <span style="background: var(--input-bg); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; color: var(--text-secondary);">${item.type}</span>
                                </div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary); margin-bottom: 0.5rem;">$${item.price}</div>
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <span style="font-weight: 500; color: var(--text-secondary);">Signal:</span>
                                    <span style="background:${color}; color:white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: bold;">${item.signal}</span>
                                </div>
                                <div style="margin-top: 5px; font-size: 0.85rem; color: var(--text-secondary); text-align: right;">Confidence: ${item.confidence}</div>
                            </div>
                        `;
                    });

                    html += `</div>`;
                } else {
                    html += `<pre>${JSON.stringify(data.details || data, null, 2)}</pre>`;
                }

                reportContainer.innerHTML = html;
            } catch (e) {
                console.error(e);
                reportContainer.innerHTML = `
                    <div style="text-align:center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fa-solid fa-triangle-exclamation" style="font-size: 2rem; color: #ffc107; margin-bottom: 1rem;"></i>
                        <p>Gagal memuat data pasar. Pastikan server backend berjalan (python src/main.py).</p>
                        <button onclick="loadMarketData()" class="btn-primary" style="margin-top:1rem;">Coba Lagi</button>
                    </div>`;
            }
        }

        // === 2. Alert Feature Logic (Real Backend) ===
        function setupAlertLogic() {
            // Sync Dropdown to Manual Input
            const assetSelect = document.getElementById('asset-select');
            const assetManual = document.getElementById('asset-manual');

            if (assetSelect) {
                assetSelect.addEventListener('change', function () {
                    if (this.value) {
                        assetManual.value = this.value;
                    }
                });
            }

            const alertForm = document.getElementById('alert-form');
            if (alertForm) {
                // Hapus semua event listener lama dengan cloneNode (trik bersih)
                const newForm = alertForm.cloneNode(true);
                alertForm.parentNode.replaceChild(newForm, alertForm);

                // Tambah listener baru yang benar

                // === FIX: Re-attach Dropdown Logic here because cloneNode killed the inline script ===
                const channelSelect = document.getElementById('channel');
                const contactInput = document.getElementById('contact-input');

                // Set initial state
                if (channelSelect.value === 'email') contactInput.placeholder = 'Masukkan alamat email Anda';

                channelSelect.addEventListener('change', function () {
                    if (this.value === 'email') {
                        contactInput.type = 'email';
                        contactInput.placeholder = 'Masukkan alamat email Anda';
                    } else if (this.value === 'whatsapp') {
                        contactInput.type = 'text';
                        contactInput.placeholder = 'Format: +628xxxxx (Gunakan kode negara)';
                    } else {
                        contactInput.type = 'text';
                        contactInput.placeholder = 'ID Chat Telegram';
                    }
                });

                newForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    // Logic: Use Manual Input priority
                    let asset = document.getElementById('asset-manual').value.trim();
                    if (!asset) {
                        asset = document.getElementById('asset-select').value;
                    }

                    if (!asset) {
                        showCustomModal("Ops!", "Harap pilih atau masukkan nama aset!", false);
                        return;
                    }

                    const condition = document.getElementById('condition').value;
                    const value = document.getElementById('value').value;
                    const channel = document.getElementById('channel').value;
                    const contact = document.getElementById('contact-input').value; // Get custom contact
                    const submitBtn = newForm.querySelector('button[type="submit"]');

                    if (!contact) {
                        showCustomModal("Kontak Kosong", "Harap masukkan kontak tujuan (Email/Nomor WA)!", false);
                        return;
                    }

                    // Loading state
                    const originalBtnText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Menyimpan...';
                    submitBtn.disabled = true;

                    try {
                        const res = await fetch('/add-alert', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                asset: asset,
                                condition: condition,
                                value: value,
                                channel: channel,
                                contact: contact // Send custom contact
                            })
                        });
                        const result = await res.json();

                        if (result.status === 'success') {

                            // === SANDBOX LINK LOGIC (AUTO - NO PROMPT) ===
                            let waLink = null;
                            if (channel === 'whatsapp') {
                                try {
                                    // Fetch global code from server
                                    const cfgRes = await fetch('/config');
                                    const cfg = await cfgRes.json();
                                    const sandboxCode = cfg.twilio_sandbox_code;

                                    if (sandboxCode) {
                                        const codeEncoded = encodeURIComponent(sandboxCode);
                                        waLink = `https://wa.me/+14155238886?text=${codeEncoded}`;
                                    }
                                } catch (err) {
                                    console.log("Config fetch error:", err);
                                }
                            }

                            // REPLACE NATIVE ALERT WITH CUSTOM MODAL
                            showCustomModal(
                                "Berhasil!",
                                `Peringatan untuk ${asset} aktif!\nNotifikasi akan dikirim ke ${channel} saat kondisi terpenuhi.`,
                                true,
                                waLink
                            );

                            // Tambahkan ke UI daftar secara visual agar user tahu
                            addAlertToUI(asset, condition, value, channel);

                            // Reset form
                            newForm.reset();
                            // Reset placeholder manual logic
                            if (channelSelect.value === 'email') contactInput.placeholder = 'Masukkan alamat email Anda';
                        } else {
                            showCustomModal("Gagal", 'Peringatan gagal dibuat: ' + (result.message || 'Error server.'), false);
                        }
                    } catch (e) {
                        console.error(e);
                        showCustomModal("Error Jaringan", 'Kesalahan jaringan. Pastikan server berjalan.', false);
                    } finally {
                        submitBtn.innerHTML = originalBtnText;
                        submitBtn.disabled = false;
                    }
                });

                // Re-bind sync logic to new nodes if needed, or just rely on IDs
                document.getElementById('asset-select').addEventListener('change', function () {
                    if (this.value) document.getElementById('asset-manual').value = this.value;
                });
            }
        }

        function addAlertToUI(asset, condition, value, channel) {
            const list = document.getElementById('active-alerts');
            if (list.innerHTML.trim() === '') list.innerHTML = '<h3 style="margin-bottom: 1rem; color: var(--accent-color);">Peringatan Aktif</h3>';

            const newItem = document.createElement('div');
            newItem.className = 'card';
            newItem.style.marginTop = '1rem';
            newItem.style.padding = '1rem';
            newItem.style.display = 'flex';
            newItem.style.justifyContent = 'space-between';
            newItem.style.alignItems = 'center';
            newItem.style.border = '1px solid var(--border-color)';
            newItem.style.background = 'var(--bg-card)';

            let channelIcon = '<i class="fa-solid fa-envelope"></i>';
            if (channel === 'whatsapp') channelIcon = '<i class="fa-brands fa-whatsapp"></i>';
            if (channel === 'telegram') channelIcon = '<i class="fa-brands fa-telegram"></i>';

            newItem.innerHTML = `
                <div style="display:flex; gap:1rem; align-items:center;">
                    <div style="font-size:1.5rem; color:var(--accent-color);">${channelIcon}</div>
                    <div>
                        <strong style="color: var(--text-primary); font-size:1.1rem;">${asset}</strong>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">${condition.replace('_', ' ').toUpperCase()} ${value ? value : ''}</div>
                    </div>
                </div>
                <div style="display:flex; align-items:center;">
                    <span style="color: #28a745; font-weight: bold; margin-right: 15px; font-size:0.8rem; border:1px solid #28a745; padding:2px 8px; border-radius:10px;">AKTIF</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background:none; border:none; color:var(--text-secondary); cursor:pointer;" title="Hapus"><i class="fa-solid fa-trash"></i></button>
                </div>
            `;
            list.appendChild(newItem);
        }

        // === 3. Theme Toggle Logic ===
        function setupTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const savedTheme = localStorage.getItem('theme');
            const body = document.body;
            const icon = themeToggle.querySelector('i');

            // Apply saved theme immediately
            if (savedTheme === 'dark') {
                body.classList.add('dark-mode');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                body.classList.remove('dark-mode');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }

            // Toggle listener
            themeToggle.addEventListener('click', () => {
                body.classList.toggle('dark-mode');
                const isDark = body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');

                if (isDark) {
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            });
        }

        // === Initialization ===
        document.addEventListener('DOMContentLoaded', () => {
            setupTheme();
            loadMarketData();
            setupAlertLogic();
        });
    </script>

</body>

</html>